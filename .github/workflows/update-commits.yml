name: Atualizar commits por repositório

on:
  schedule:
    - cron: "0 12 * * *"  # roda todo dia às 12h (UTC)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Instalar dependências
        run: sudo apt-get install jq

      - name: Gerar métrica de commits por repositório com linguagens
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: bkarln
        run: |
          echo '<!--COMMIT_SECTION_START-->' > commits.md
          echo '### 📦 Commits por repositório' >> commits.md
          echo '<div align="center">' >> commits.md
          echo '<table>' >> commits.md

          repos=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/users/$USERNAME/repos?per_page=100" | jq -r '.[].name')

          row_count=0
          for repo in $repos; do
            count=$(curl -s -I -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$USERNAME/$repo/commits?per_page=1" \
              | grep -i ^Link \
              | sed -n 's/.*page=\([0-9]*\).*rel="last".*/\1/p')

            langs=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$USERNAME/$repo/languages" | jq -r 'keys | join(", ")')

            color="blue"

            if [[ $((row_count % 3)) == 0 ]]; then
              echo '<tr>' >> commits.md
            fi

            echo "<td align=\"center\">" >> commits.md
            echo "<strong>📁 $repo</strong><br/>" >> commits.md
            echo "<img src=\"https://img.shields.io/badge/Commits-${count:-1}-$color?style=for-the-badge\"/><br/>" >> commits.md
            echo "<sub>🧠 ${langs:-Sem linguagem}</sub>" >> commits.md
            echo "</td>" >> commits.md

            row_count=$((row_count + 1))
            if [[ $((row_count % 3)) == 0 ]]; then
              echo '</tr>' >> commits.md
            fi
          done

          if [[ $((row_count % 3)) != 0 ]]; then
            echo '</tr>' >> commits.md
          fi

          echo '</table>' >> commits.md
          echo '</div>' >> commits.md
          echo '<!--COMMIT_SECTION_END-->' >> commits.md

      - name: Atualizar README.md
        run: |
          start='<!--COMMIT_SECTION_START-->'
          end='<!--COMMIT_SECTION_END-->'

          echo "$start" > new_commits.md
          cat commits.md >> new_commits.md
          echo "$end" >> new_commits.md

          awk -v start="$start" -v end="$end" '
            BEGIN {in_block=0}
            $0 == start {print; in_block=1; while ((getline line < "new_commits.md") > 0) print line; next}
            $0 == end {in_block=0; next}
            !in_block {print}
          ' README.md > README_temp.md && mv README_temp.md README.md

      - name: Commit e push
        run: |
          git config --local user.email "karolaine.b@gmail.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Atualiza métrica de commits por repositório"
          git push
