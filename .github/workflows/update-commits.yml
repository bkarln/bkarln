name: Atualizar commits por repositório

on:
  schedule:
    - cron: "0 12 * * *"  # roda todo dia às 12h
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Instalar dependências
        run: sudo apt-get install jq

      - name: Gerar métrica de commits por repositório
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: bkarln
        run: |
          echo "### 📦 Commits por repositório" > commits.md
          echo "" >> commits.md

          repos=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/users/$USERNAME/repos?per_page=100 | jq -r '.[].name')

          for repo in $repos; do
            count=$(curl -s -I -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/$USERNAME/$repo/commits?per_page=1 \
              | grep -i ^Link \
              | sed -n 's/.*page=\([0-9]*\).*rel="last".*/\1/p')

            echo "- **$repo**: ${count:-1} commits" >> commits.md
          done

      - name: Atualizar README.md
        run: |
          sed -i '/<!--COMMIT_SECTION_START-->/,/<!--COMMIT_SECTION_END-->/c\
<!--COMMIT_SECTION_START-->\n'"$(cat commits.md)"'\n<!--COMMIT_SECTION_END-->' README.md

      - name: Commit e push
        run: |
          git config --local user.email "karolaine@users.noreply.github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Atualiza métrica de commits por repositório"
          git push
